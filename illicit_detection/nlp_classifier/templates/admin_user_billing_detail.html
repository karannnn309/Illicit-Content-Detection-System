{% extends 'base.html' %}

{% block title %}User Billing Details - ZiNUS{% endblock %}

{% block content %}
<div class="container" style="padding: 40px 0;">
    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.1);">
        <!-- Back Button -->
        <a href="{% url 'admin_billing_dashboard' %}" 
           style="display: inline-block; color: var(--primary); text-decoration: none; margin-bottom: 20px;">
            <i class="fas fa-arrow-left"></i> Back to Billing Dashboard
        </a>

        <!-- User Info Header -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); 
                    padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem;">
                <i class="fas fa-user-circle"></i> {{ target_user.username }}
            </h1>
            <p style="margin: 0; opacity: 0.9;">{{ target_user.email }}</p>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">
                Member since: {{ target_user.date_joined|date:"M d, Y" }}
            </p>
        </div>

        <!-- Summary Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary);">
                <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">Total Revenue (All Time)</p>
                <h2 style="margin: 10px 0 0 0; color: var(--primary);">${{ total_all_time|floatformat:2 }}</h2>
            </div>
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">Total Requests (All Time)</p>
                <h2 style="margin: 10px 0 0 0; color: #856404;">{{ total_requests_all_time }}</h2>
            </div>
            <div style="background: #d4edda; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">Active API Keys</p>
                <h2 style="margin: 10px 0 0 0; color: #155724;">{{ api_keys.count }}</h2>
            </div>
        </div>

        <!-- API Keys Section -->
        <section style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                <i class="fas fa-key"></i> API Keys
            </h2>
            {% if api_keys %}
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Key</th>
                                <th style="padding: 12px; text-align: center;">Tier</th>
                                <th style="padding: 12px; text-align: center;">Requests Today</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                                <th style="padding: 12px; text-align: center;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key in api_keys %}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;"><strong>{{ key.name }}</strong></td>
                                <td style="padding: 12px;">
                                    <code style="background: #f8f9fa; padding: 5px; border-radius: 4px; font-size: 0.85rem;">
                                        {{ key.key|slice:":20" }}...
                                    </code>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="background: #e7f3ff; color: var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">
                                        {{ key.get_tier_display }}
                                    </span>
                                </td>
                                <td style="padding: 12px; text-align: center;">{{ key.requests_today }}/{{ key.daily_limit }}</td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if key.is_active %}
                                        <span style="color: #28a745;"><i class="fas fa-check-circle"></i> Active</span>
                                    {% else %}
                                        <span style="color: #dc3545;"><i class="fas fa-times-circle"></i> Inactive</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">{{ key.created_at|date:"M d, Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p style="text-align: center; color: #6c757d; padding: 40px;">User has no API keys.</p>
            {% endif %}
        </section>

        <!-- Billing History -->
        <section>
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                <i class="fas fa-history"></i> Billing History
            </h2>
            {% if billing_records %}
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Period</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Total Requests</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Free Requests</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Paid Requests</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Cost/Request</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Amount Charged</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in billing_records %}
                            <tr style="border-bottom: 1px solid #eee; {% if forloop.first %}background: #fffbf0;{% endif %}">
                                <td style="padding: 12px;">
                                    <strong>{{ record.year }}/{{ record.month|stringformat:"02d" }}</strong>
                                    {% if forloop.first %}
                                        <span style="background: #ffc107; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px;">
                                            Current
                                        </span>
                                    {% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <strong>{{ record.total_requests }}</strong>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="color: #28a745;">{{ record.free_requests_used }}</span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="color: #dc3545;">{{ record.paid_requests }}</span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    ${{ record.cost_per_request|floatformat:4 }}
                                </td>
                                <td style="padding: 12px; text-align: right;">
                                    <strong style="font-size: 1.1rem; color: {% if record.amount_charged > 0 %}#28a745{% else %}#6c757d{% endif %};">
                                        ${{ record.amount_charged|floatformat:2 }}
                                    </strong>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {{ record.last_updated|date:"M d, Y" }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid var(--primary);">
                                <td style="padding: 12px;">TOTAL</td>
                                <td style="padding: 12px; text-align: center;">{{ total_requests_all_time }}</td>
                                <td colspan="3" style="padding: 12px; text-align: center;">-</td>
                                <td style="padding: 12px; text-align: right; color: #28a745; font-size: 1.2rem;">
                                    ${{ total_all_time|floatformat:2 }}
                                </td>
                                <td style="padding: 12px;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <p style="text-align: center; color: #6c757d; padding: 40px;">No billing history available for this user.</p>
            {% endif %}
        </section>

        <!-- Info Note -->
        <div style="background: #e7f3ff; border-left: 4px solid var(--primary); padding: 15px; margin-top: 30px; border-radius: 5px;">
            <p style="margin: 0; color: #495057;">
                <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                <strong>Note:</strong> Free tier includes 50 requests per day. Additional requests are charged at $0.01 per request.
            </p>
        </div>
    </div>
</div>
{% endblock %}
